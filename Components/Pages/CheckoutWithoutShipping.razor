@page "/checkout-pickup"
@rendermode InteractiveServer
@using MaisonTelecom.Services
@using MaisonTelecom.Models
@using MaisonTelecom.ViewModels
@inject StateContainer State
@inject NavigationManager NavigationManager
@implements IDisposable

<div class="checkout-page">
    <div class="checkout-form">
        <EditForm Model="@checkoutModel" OnValidSubmit="HandleCheckout">
            <div class="delivery-section">
                <h2>Delivery</h2>
                <div class="delivery-options">
                    <label class="radio-option active">
                        <div>
                            <input type="radio" name="delivery" value="pickup" checked />
                            <span>Pickup in store</span>
                        </div>
                        <i class="fas fa-store"></i>
                    </label>
                    <label class="radio-option" @onclick='() => NavigationManager.NavigateTo("/checkout-shipping")'>
                        <div>
                            <input type="radio" name="delivery" value="ship" />
                            <span>Ship</span>
                        </div>
                        <i class="fas fa-truck"></i>
                    </label>
                </div>
            </div>

            <div class="location-section">
                <h2>Shop Location</h2>
                <input type="text" value="Douala, Cameroon" readonly />
            </div>

            <div class="payment-section">
                <h2>Payment</h2>
                <p>All transactions are secure and encrypted.</p>
                <div class="payment-methods">
                    <p>Payment Methods</p>
                    <div>
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMy4zMyAzMiI+PHBhdGggZD0iTTIzLDJWMzBoLjc5Yy4yOSwwLC41My0uMjQsLjUzLS41NFYyLjU0YzAtLjI5LS4yNC0uNTQtLjUzLS41NGgtLjc5WiIgZmlsbD0iI2ZjMGUwMCIvPjxwYXRoIGQ9Ik0yMywyVjMwSDUuODhjLS4yOSwwLS41My0uMjQtLjUzLS41NFYyLjU0YzAtLjI5LC4yNC0uNTQsLjUzLS41NGg1Ljg2VjJoOC43M1oiIGZpbGw9IiNmZGNjMDAiLz48cGF0aCBkPSJtNC42MywxMC45NnYxMC4xNGMwLC4yOS0uMjQsLjUzLS41MywuNTNIMy41NGMtLjI5LDAtLjUzLS4yNC0uNTMtLjUzVjExYy4wMS0uMywuMjQtLjUzLC41NC0uNTNoLjU5Yy4yOSwwLC41MywuMjQuNTMsLjU0WiIgZmlsbD0iI2M5M2ExMCIvPjxwYXRoIGQ9Ik0zLjU0LDIxLjYyYy0uMywwLS41NC0uMjQtLjU0LS41NFYxMS4wMWMwLS4zLC4yNC0uNTMsLjU0LS41M2gxLjA5VjIxLjYyaC0xLjA5WiIgZmlsbD0iI2YyYjYwMCIvPjxwYXRoIGQ9Ik0yMywyVjMwSDkuNTJjLS4zLDAtLjU0LS4yNC0uNTQtLjU0VjIuNTRjMC0uMywuMjQtLjU0LC41NC0uNTNoMS4wN1YySDIzWiIgZmlsbD0iI2ZmZTc5OCIvPjxwYXRoIGQ9Im0xOC40MSwyNGgtMS4zN2ExLjM4LDEuMzgsMCwwLDEtMS4zNy0xLjM3di0uNzJjMC0uNzYuNjItMS4zNywxLjM3LTEuMzdoMS4zN1oiIGZpbGw9IiMwMDkzZDAiLz48cGF0aCBkPSJtMTcuMDUsMjAuNTFoMS4zN1YyNEgxNi4yN2ExLjM4LDEuMzgsMCwwLDEtMS4zOC0xLjM4di0uNzJjMC0uNzYuNjEtMS4zOCwxLjM4LTEuMzhaIiBmaWxsPSIjMDA3OWNjIi8+PHBhdGggZD0ibTE4LjQxLDIwLjUxaC0xLjM3YTEuMzcsMS4zNywwLDAsMC0xLjM4LDEuMzh2LjcyYzAsLjc2LjYyLDEuMzgsMS4zOCwxLjM4aDEuMzdaIiBmaWxsPSIjMDA4NmNhIi8+PHBhdGggZD0ibTE4LjE0LDIwLjUxaC0xLjA5di41NGMwLC4zLS4yNC41NC0uNTQuNTNoLS4yN2ExLjM3LDEuMzcsMCwwLDAtMS4zOCwxLjM4di43MmMwLC43Ni42MiwxLjM4LDEuMzgsMS4zOGgxLjM3di0zLjU1WiIgZmlsbD0iIzAwYTJkMiIvPjxwYXRoIGQ9Im0yMS4yNiwyMC41MXYtMS4wOWMwLS4zLS4yNC0uNTQtLjUzLS41M2gtLjg2YTEuMzcsMS4zNywwLDAsMC0xLjM4LDEuMzh2NC4zOGMwLC43Ni42MiwxLjM4LDEuMzgsMS4zOGgxLjM3VjIwLjUxaC0uNTMtLjU0WiIgZmlsbD0iIzAwOTNkMCIvPjxwYXRoIGQ9Ik0yMC43MywyMy40NnYxLjA5aC41M2ExLjM4LDEuMzgsMCwwLDAsMS4zOC0xLjM4di00LjM4YzAtLjc2LS42MS0xLjM4LTEuMzgtMS4zOGgtLjg2Yy0uMywwLS41My4yNC0uNTMuNTN2MS4wOWguNTN2Mi43M2gtLjUzWiIgZmlsbD0iIzAwYTJkMiIvPjxwYXRoIGQ9Im0yMS4yNiwxOS40M2gtLjg2YTEuMzcsMS4zNywwLDAsMC0xLjM4LDEuMzh2MS42M2gxLjA5VjIyaDEuMDl2LTEuNjNjMC0uNzYtLjYyLTEuMzgtMS4zOC0xLjM4aC0uNTNWMTkuOTdoLjg2YzAsMCwwLC41NCwwLC41NFYxOS40M1oiIGZpbGw9IiMwMDc5Y2MiLz48cGF0aCBkPSJNMjEuMjYsMTkuNDNoLS44NmExLjM4LDEuMzgsMCwwLDAtMS4zOCwxLjM4djQuMzhjMCwuNzYuNjIsMS4zOCwxLjM4LDEuMzhoMS4zN3YtMS4wOWgtLjUzVjIwLjUxaC41M3YtMS4wOWMwLS4zLS4yNC0uNTQtLjUzLS41NFoiIGZpbGw9IiMwMDc4Y2IiLz48cGF0aCBkPSJtMTkuNDksMTAuOTZ2LjU0YzAsLjI5LS4yNC41My0uNTMuNTN2Mi4xN2MwLC4zLS4yNC41NC0uNTQuNTRIOS42NmMtLjMsMC0uNTQtLjI0LS41NC0uNTN2LS41MmMwLS4zLS4yNC0uNTQtLjU0LS41NEg0LjEzYy0uMywwLS41NC0uMjQtLjU0LS41NHYtLjU0YzAtLjI5LC4yNC0uNTMsLjU0LS41M2g1LjkzYy4zLDAsLjU0LS4yNC41NC0uNTNWOS4xM2MwLS4zLC4yNC0uNTQsLjU0LS41NGg3LjI1YzAsLjI5LC4yNC41MywuNTQuNTN2MS4wOWgwWiIgZmlsbD0iI2YyYjYwMCIvPjxwYXRoIGQ9Im0xOC45NiwxMS40OXYyLjE3YzAsLjMtLjI0LjU0LS41NC41NEg5LjY2Yy0uMywwLS41NC0uMjQtLjU0LS41NFYxMi41YzAtLjI5LS4yNC0uNTMtLjU0LS41M0g0LjEzYy0uMywwLS41NC0uMjQtLjU0LS41NHYtLjU0YzAsLjMtLjI0LjU0LS41NC41NGgwYy0uMywwLS41NC0uMjQtLjU0LS41NFY5LjEyYzAtLjMsLjI0LS41MywuNTQtLjUzaDguMDVjLjI5LDAsLjUzLC4yNCwuNTMsLjUzdjEuMmMwLC4zLC4yNC41NCwuNTQuNTRIOS4xMXYtMS42M2g3LjI1YzAsLjI5LC4yNC41MywuNTQuNTN2MS4wOWgwWiIgZmlsbD0iI2ZmZTc5OCIvPjxwYXRoIGQ9Ik0zLjU0LDEzLjczYzAtLjI5LC4yNC0uNTMsLjU0LS41M2g0LjQzYy4yOSwwLC41My0uMjQuNTMtLjU0VjkuMTFjMC0uMy4yNC0uNTQuNTQtLjU0aDcuMjVjLjI5LDAsLjUzLjI0LC41My41M3YxLjA5YzAsLjI5LC4yNC41NCwuNTQuNTRoMS4wOXYtNC4zOGgtMS4wOXYtMS4wOWgtNy4yNWMwLDAsMC0uNTQsMC0uNTNoLS41NFYyLjU0SDkuMTFjLS4zLDAsLjU0LS4yNCwuNTQtLjU0SDMuNTNjLS4zLDAsLjU0LS4yNCwuNTQtLjU0djEwLjE0YzAsLjI5LS4yNC41NC0uNTQuNTNIMi40NmMwLDAsMCwuNTQsMCwuNTRoLjU0YzAsLjI5LDAsLjU0LDAsLjU0WiIgZmlsbD0iI2ZjMGUwMCIvPjxwYXRoIGQ9Ik04LjU5LDkuNjZWMzBIMy41NGMtLjMsMC0uNTMtLjI0LS41My0uNTQtLjg2LDAtLjg2LDAtLjg2LDBoLDBjLS4yOSwwLS41NC0uMjQtLjU0LS41NFY5LjEyYzAtLjMsLjI4LS41MywuNTQtLjUzSDguMDVWOS4xMmgwYzAtLjI5LjI0LS41My41NC0uNTNaIiBmaWxsPSIjZjJiNjAwIi8+PHBhdGggZD0iTTkuNjYsOS4xMnYxOS43MWgtMS4xVjkuMTJoMS4xWiIgZmlsbD0iI2ZmZTc5OCIvPjxwYXRoIGQ9Ik0yMy4zMywzMiwwLDMyLDAsMEgyMy4zM1oiIGZpbGw9Im5vbmUiLz48L3N2Zz4=" alt="MTN Mobile Money" style="height: 50px; margin-right: 15px;" />
                        <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNzUycHQiIGhlaWdodD0iNzUycHQiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc1MiA3NTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiA8cGF0aCBkPSJtMzc2LjQ3IDEwMi4zN2MtMTQ3LjAzIDAtMjY2LjM0IDExOS4zMS0yNjYuMzQgMjY2LjM0czExOS4zMSAyNjYuMzQgMjY2LjM0IDIYNi4zNGMxNDcuMDQgMCAyNjYuMzQtMTE5LjMxIDI2Ni4zNC0yNjYuMzRzLTExOS4zLTI2Ni4zNC0yNjYuMzQtMjY2LjM0em0xODguNjYgMjc3LjM3aC0xMjAuNDR2LTEwOS42MWMwLTMzLjAxOC0yNi43OTQtNTkuODExLTU5LjgxMS01OS44MTFoLTE3LjN2MTY5LjQySDIxMS43OHYtMjM4LjgyaDEyMC40NHYxMDkuNjFjMCAzMy4wMTggMjYuNzk0IDU5LjgxMSA1OS44MTEgNTkuODExaDE3LjN2LTE2OS40MmgxMjcuNDF6IiBmaWxsPSIjZjYwIi8+Cjwvc3ZnPgo=" alt="Orange Money" style="height: 50px;" />
                    </div>
                    <p class="payment-note">After clicking "Pay Now", you will be redirected to complete your purchase securely.</p>
                </div>
            </div>
            <button type="submit" class="pay-now-button">Pay Now</button>
        </EditForm>
    </div>

    <div class="order-summary">
        <h2>Order Summary</h2>
        @if (State.Cart.Any())
        {
            @foreach (var item in State.Cart)
            {
                <div class="summary-item">
                    <img src="@(string.IsNullOrEmpty(item.Product.ImageURL1) ? "/Image/iphone_thumb.jpg" : item.Product.ImageURL1)" alt="@item.Product.Name" />
                    <div>
                        <p>@item.Product.Name</p>
                        <p>FCFA @item.Product.Price.ToString("N0")</p>
                        <p>Quantity: @item.Quantity</p>
                    </div>
                </div>
            }
            <hr />
            <div class="summary-total">
                <p>Subtotal: @State.Cart.Sum(i => i.Quantity) items <span>FCFA @Subtotal.ToString("N0")</span></p>
            </div>
            <hr />
            <div class="summary-grand-total">
                <p>Total <span>FCFA @(Subtotal.ToString("N0"))</span></p>
            </div>
        }
        else
        {
            <p>Your cart is empty.</p>
        }
    </div>
</div>

@code {
    private CheckoutViewModel checkoutModel = new();
    private decimal Subtotal => State.Cart.Any() ? State.Cart.Sum(item => item.Product.Price * item.Quantity) : 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await State.InitializeAsync();
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        State.OnStateChange += StateHasChanged;
    }

    private void HandleCheckout(EditContext context)
    {
        NavigationManager.NavigateTo("/order-confirmation");
    }

    public void Dispose()
    {
        State.OnStateChange -= StateHasChanged;
    }
}